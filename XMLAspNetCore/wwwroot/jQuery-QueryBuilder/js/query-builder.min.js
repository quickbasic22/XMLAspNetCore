!function(e,t){"function"==typeof define&&define.amd?define(["jquery","jquery-extendext"],t):"object"==typeof module&&module.exports?module.exports=t(require("jquery"),require("jquery-extendext")):t(e.jQuery)}(this,function(d){"use strict";function c(e,t){(e[0].queryBuilder=this).$el=e,this.settings=d.extendext(!0,"replace",{},c.DEFAULTS,t),this.model=new r,this.status={id:null,generated_id:!1,group_id:0,rule_id:0,has_optgroup:!1,has_operator_optgroup:!1},this.filters=this.settings.filters,this.icons=this.settings.icons,this.operators=this.settings.operators,this.templates=this.settings.templates,this.plugins=this.settings.plugins,this.lang=null,void 0===c.regional.en&&f.error("Config",'"i18n/en.js" not loaded.'),this.lang=d.extendext(!0,"replace",{},c.regional.en,c.regional[this.settings.lang_code],this.settings.lang),!1===this.settings.allow_groups?this.settings.allow_groups=0:!0===this.settings.allow_groups&&(this.settings.allow_groups=-1),Object.keys(this.templates).forEach(function(e){if(this.templates[e]||(this.templates[e]=c.templates[e]),"function"!=typeof this.templates[e])throw new Error(`Template ${e} must be a function`)},this),this.$el.attr("id")||(this.$el.attr("id","qb_"+Math.floor(99999*Math.random())),this.status.generated_id=!0),this.status.id=this.$el.attr("id"),this.$el.addClass("query-builder form-inline"),this.filters=this.checkFilters(this.filters),this.operators=this.checkOperators(this.operators),this.bindEvents(),this.initPlugins()}d.extend(c.prototype,{trigger:function(e){e=new d.Event(this._tojQueryEvent(e),{builder:this});return this.$el.triggerHandler(e,Array.prototype.slice.call(arguments,1)),e},change:function(e,t){e=new d.Event(this._tojQueryEvent(e,!0),{builder:this,value:t});return this.$el.triggerHandler(e,Array.prototype.slice.call(arguments,2)),e.value},on:function(e,t){return this.$el.on(this._tojQueryEvent(e),t),this},off:function(e,t){return this.$el.off(this._tojQueryEvent(e),t),this},once:function(e,t){return this.$el.one(this._tojQueryEvent(e),t),this},_tojQueryEvent:function(e,t){return e.split(" ").map(function(e){return e+".queryBuilder"+(t?".filter":"")}).join(" ")}}),c.types={string:"string",integer:"number",double:"number",date:"datetime",time:"datetime",datetime:"datetime",boolean:"boolean"},c.inputs=["text","number","textarea","radio","checkbox","select"],c.modifiable_options=["display_errors","allow_groups","allow_empty","default_condition","default_filter"],c.selectors={group_container:".rules-group-container",rule_container:".rule-container",filter_container:".rule-filter-container",operator_container:".rule-operator-container",value_container:".rule-value-container",error_container:".error-container",condition_container:".rules-group-header .group-conditions",rule_header:".rule-header",group_header:".rules-group-header",group_actions:".group-actions",rule_actions:".rule-actions",rules_list:".rules-group-body>.rules-list",group_condition:".rules-group-header [name$=_cond]",rule_filter:".rule-filter-container [name$=_filter]",rule_operator:".rule-operator-container [name$=_operator]",rule_value:".rule-value-container [name*=_value_]",add_rule:"[data-add=rule]",delete_rule:"[data-delete=rule]",add_group:"[data-add=group]",delete_group:"[data-delete=group]"},c.templates={},c.regional={},c.OPERATORS={equal:{type:"equal",nb_inputs:1,multiple:!1,apply_to:["string","number","datetime","boolean"]},not_equal:{type:"not_equal",nb_inputs:1,multiple:!1,apply_to:["string","number","datetime","boolean"]},in:{type:"in",nb_inputs:1,multiple:!0,apply_to:["string","number","datetime"]},not_in:{type:"not_in",nb_inputs:1,multiple:!0,apply_to:["string","number","datetime"]},less:{type:"less",nb_inputs:1,multiple:!1,apply_to:["number","datetime"]},less_or_equal:{type:"less_or_equal",nb_inputs:1,multiple:!1,apply_to:["number","datetime"]},greater:{type:"greater",nb_inputs:1,multiple:!1,apply_to:["number","datetime"]},greater_or_equal:{type:"greater_or_equal",nb_inputs:1,multiple:!1,apply_to:["number","datetime"]},between:{type:"between",nb_inputs:2,multiple:!1,apply_to:["number","datetime"]},not_between:{type:"not_between",nb_inputs:2,multiple:!1,apply_to:["number","datetime"]},begins_with:{type:"begins_with",nb_inputs:1,multiple:!1,apply_to:["string"]},not_begins_with:{type:"not_begins_with",nb_inputs:1,multiple:!1,apply_to:["string"]},contains:{type:"contains",nb_inputs:1,multiple:!1,apply_to:["string"]},not_contains:{type:"not_contains",nb_inputs:1,multiple:!1,apply_to:["string"]},ends_with:{type:"ends_with",nb_inputs:1,multiple:!1,apply_to:["string"]},not_ends_with:{type:"not_ends_with",nb_inputs:1,multiple:!1,apply_to:["string"]},is_empty:{type:"is_empty",nb_inputs:0,multiple:!1,apply_to:["string"]},is_not_empty:{type:"is_not_empty",nb_inputs:0,multiple:!1,apply_to:["string"]},is_null:{type:"is_null",nb_inputs:0,multiple:!1,apply_to:["string","number","datetime","boolean"]},is_not_null:{type:"is_not_null",nb_inputs:0,multiple:!1,apply_to:["string","number","datetime","boolean"]}},c.DEFAULTS={filters:[],plugins:[],sort_filters:!1,display_errors:!0,allow_groups:-1,allow_empty:!1,conditions:["AND","OR"],default_condition:"AND",inputs_separator:" , ",select_placeholder:"------",display_empty_filter:!0,default_filter:null,optgroups:{},default_rule_flags:{filter_readonly:!1,operator_readonly:!1,value_readonly:!1,no_delete:!1},default_group_flags:{condition_readonly:!1,no_add_rule:!1,no_add_group:!1,no_delete:!1},templates:{group:null,rule:null,filterSelect:null,operatorSelect:null,ruleValueSelect:null},lang_code:"en",lang:{},operators:["equal","not_equal","in","not_in","less","less_or_equal","greater","greater_or_equal","between","not_between","begins_with","not_begins_with","contains","not_contains","ends_with","not_ends_with","is_empty","is_not_empty","is_null","is_not_null"],icons:{add_group:"glyphicon glyphicon-plus-sign",add_rule:"glyphicon glyphicon-plus",remove_group:"glyphicon glyphicon-remove",remove_rule:"glyphicon glyphicon-remove",error:"glyphicon glyphicon-warning-sign"}},c.plugins={},c.defaults=function(e){if("object"!=typeof e)return"string"==typeof e?"object"==typeof c.DEFAULTS[e]?d.extend(!0,{},c.DEFAULTS[e]):c.DEFAULTS[e]:d.extend(!0,{},c.DEFAULTS);d.extendext(!0,"replace",c.DEFAULTS,e)},c.define=function(e,t,r){c.plugins[e]={fct:t,def:r||{}}},c.extend=function(e){d.extend(c.prototype,e)},c.prototype.initPlugins=function(){var t;this.plugins&&(d.isArray(this.plugins)&&(t={},this.plugins.forEach(function(e){t[e]=null}),this.plugins=t),Object.keys(this.plugins).forEach(function(e){e in c.plugins?(this.plugins[e]=d.extend(!0,{},c.plugins[e].def,this.plugins[e]||{}),c.plugins[e].fct.call(this,this.plugins[e])):f.error("Config",'Unable to find plugin "{0}"',e)},this))},c.prototype.getPluginOptions=function(e,t){var r;if(this.plugins&&this.plugins[e]?r=this.plugins[e]:c.plugins[e]&&(r=c.plugins[e].def),r)return t?r[t]:r;f.error("Config",'Unable to find plugin "{0}"',e)},c.prototype.init=function(e){this.trigger("afterInit"),e?(this.setRules(e),delete this.settings.rules):this.setRoot(!0)},c.prototype.checkFilters=function(e){var r,t=[];return e&&0!==e.length||f.error("Config","Missing filters list"),e.forEach(function(n,e){switch(n.id||f.error("Config","Missing filter {0} id",e),-1!=t.indexOf(n.id)&&f.error("Config",'Filter "{0}" already defined',n.id),t.push(n.id),n.type?c.types[n.type]||f.error("Config",'Invalid type "{0}"',n.type):n.type="string",n.input?"function"!=typeof n.input&&-1==c.inputs.indexOf(n.input)&&f.error("Config",'Invalid input "{0}"',n.input):n.input="number"===c.types[n.type]?"number":"text",n.operators&&n.operators.forEach(function(e){"string"!=typeof e&&f.error("Config","Filter operators must be global operators types (string)")}),n.field||(n.field=n.id),n.label||(n.label=n.field),n.optgroup?(this.status.has_optgroup=!0,this.settings.optgroups[n.optgroup]||(this.settings.optgroups[n.optgroup]=n.optgroup)):n.optgroup=null,n.input){case"radio":case"checkbox":(!n.values||n.values.length<1)&&f.error("Config",'Missing filter "{0}" values',n.id);break;case"select":var i=[];n.has_optgroup=!1,f.iterateOptions(n.values,function(e,t,r){i.push({value:e,label:t,optgroup:r||null}),r&&(n.has_optgroup=!0,this.settings.optgroups[r]||(this.settings.optgroups[r]=r))}.bind(this)),n.has_optgroup?n.values=f.groupSort(i,"optgroup"):n.values=i,n.placeholder&&(void 0===n.placeholder_value&&(n.placeholder_value=-1),n.values.forEach(function(e){e.value==n.placeholder_value&&f.error("Config",'Placeholder of filter "{0}" overlaps with one of its values',n.id)}))}},this),this.settings.sort_filters&&("function"==typeof this.settings.sort_filters?e.sort(this.settings.sort_filters):(r=this,e.sort(function(e,t){return r.translate(e.label).localeCompare(r.translate(t.label))}))),e=this.status.has_optgroup?f.groupSort(e,"optgroup"):e},c.prototype.checkOperators=function(r){var n=[];return r.forEach(function(e,t){"string"==typeof e?(c.OPERATORS[e]||f.error("Config",'Unknown operator "{0}"',e),r[t]=e=d.extendext(!0,"replace",{},c.OPERATORS[e])):(e.type||f.error("Config",'Missing "type" for operator {0}',t),c.OPERATORS[e.type]&&(r[t]=e=d.extendext(!0,"replace",{},c.OPERATORS[e.type],e)),void 0!==e.nb_inputs&&void 0!==e.apply_to||f.error("Config",'Missing "nb_inputs" and/or "apply_to" for operator "{0}"',e.type)),-1!=n.indexOf(e.type)&&f.error("Config",'Operator "{0}" already defined',e.type),n.push(e.type),e.optgroup?(this.status.has_operator_optgroup=!0,this.settings.optgroups[e.optgroup]||(this.settings.optgroups[e.optgroup]=e.optgroup)):e.optgroup=null},this),r=this.status.has_operator_optgroup?f.groupSort(r,"optgroup"):r},c.prototype.bindEvents=function(){var o=this,t=c.selectors;this.$el.on("change.queryBuilder",t.group_condition,function(){var e;d(this).is(":checked")&&(e=d(this).closest(t.group_container),o.getModel(e).condition=d(this).val())}),this.$el.on("change.queryBuilder",t.rule_filter,function(){var e=d(this).closest(t.rule_container);o.getModel(e).filter=o.getFilterById(d(this).val())}),this.$el.on("change.queryBuilder",t.rule_operator,function(){var e=d(this).closest(t.rule_container);o.getModel(e).operator=o.getOperatorByType(d(this).val())}),this.$el.on("click.queryBuilder",t.add_rule,function(){var e=d(this).closest(t.group_container);o.addRule(o.getModel(e))}),this.$el.on("click.queryBuilder",t.delete_rule,function(){var e=d(this).closest(t.rule_container);o.deleteRule(o.getModel(e))}),0!==this.settings.allow_groups&&(this.$el.on("click.queryBuilder",t.add_group,function(){var e=d(this).closest(t.group_container);o.addGroup(o.getModel(e))}),this.$el.on("click.queryBuilder",t.delete_group,function(){var e=d(this).closest(t.group_container);o.deleteGroup(o.getModel(e))})),this.model.on({drop:function(e,t){t.$el.remove(),o.refreshGroupsConditions()},add:function(e,t,r,n){0===n?r.$el.prependTo(t.$el.find(">"+c.selectors.rules_list)):r.$el.insertAfter(t.rules[n-1].$el),o.refreshGroupsConditions()},move:function(e,t,r,n){t.$el.detach(),0===n?t.$el.prependTo(r.$el.find(">"+c.selectors.rules_list)):t.$el.insertAfter(r.rules[n-1].$el),o.refreshGroupsConditions()},update:function(e,t,r,n,i){if(t instanceof l)switch(r){case"error":o.updateError(t);break;case"flags":o.applyRuleFlags(t);break;case"filter":o.updateRuleFilter(t,i);break;case"operator":o.updateRuleOperator(t,i);break;case"value":o.updateRuleValue(t,i)}else switch(r){case"error":o.updateError(t);break;case"flags":o.applyGroupFlags(t);break;case"condition":o.updateGroupCondition(t,i)}}})},c.prototype.setRoot=function(e,t,r){e=void 0===e||!0===e;var n=this.nextGroupId(),n=d(d.parseHTML(this.getGroupTemplate(n,1)));return this.$el.append(n),this.model.root=new a(null,n),this.model.root.model=this.model,this.model.root.data=t,this.model.root.flags=d.extend({},this.settings.default_group_flags,r),this.model.root.condition=this.settings.default_condition,this.trigger("afterAddGroup",this.model.root),e&&this.addRule(this.model.root),this.model.root},c.prototype.addGroup=function(e,t,r,n){var i,o=e.level+1;return this.trigger("beforeAddGroup",e,t=void 0===t||!0===t,o).isDefaultPrevented()?null:(i=this.nextGroupId(),i=d(this.getGroupTemplate(i,o)),(o=e.addGroup(i)).data=r,o.flags=d.extend({},this.settings.default_group_flags,n),o.condition=this.settings.default_condition,this.trigger("afterAddGroup",o),this.trigger("rulesChanged"),t&&this.addRule(o),o)},c.prototype.deleteGroup=function(e){var t;return!e.isRoot()&&!this.trigger("beforeDeleteGroup",e).isDefaultPrevented()&&(t=!0,e.each("reverse",function(e){t&=this.deleteRule(e)},function(e){t&=this.deleteGroup(e)},this),t&&(e.drop(),this.trigger("afterDeleteGroup"),this.trigger("rulesChanged")),t)},c.prototype.updateGroupCondition=function(t,e){t.$el.find(">"+c.selectors.group_condition).each(function(){var e=d(this);e.prop("checked",e.val()===t.condition),e.parent().toggleClass("active",e.val()===t.condition)}),this.trigger("afterUpdateGroupCondition",t,e),this.trigger("rulesChanged")},c.prototype.refreshGroupsConditions=function(){!function t(e){e.flags&&(!e.flags||e.flags.condition_readonly)||e.$el.find(">"+c.selectors.group_condition).prop("disabled",e.rules.length<=1).parent().toggleClass("disabled",e.rules.length<=1),e.each(null,function(e){t(e)},this)}(this.model.root)},c.prototype.addRule=function(e,t,r){var n;return this.trigger("beforeAddRule",e).isDefaultPrevented()?null:(n=this.nextRuleId(),n=d(d.parseHTML(this.getRuleTemplate(n))),(e=e.addRule(n)).data=t,e.flags=d.extend({},this.settings.default_rule_flags,r),this.trigger("afterAddRule",e),this.trigger("rulesChanged"),this.createRuleFilters(e),!this.settings.default_filter&&this.settings.display_empty_filter||(e.filter=this.change("getDefaultFilter",this.getFilterById(this.settings.default_filter||this.filters[0].id),e)),e)},c.prototype.deleteRule=function(e){return!e.flags.no_delete&&!this.trigger("beforeDeleteRule",e).isDefaultPrevented()&&(e.drop(),this.trigger("afterDeleteRule"),this.trigger("rulesChanged"),!0)},c.prototype.createRuleFilters=function(e){var t=this.change("getRuleFilters",this.filters,e),t=d(d.parseHTML(this.getRuleFilterSelect(e,t)));e.$el.find(c.selectors.filter_container).html(t),this.trigger("afterCreateRuleFilters",e),this.applyRuleFlags(e)},c.prototype.createRuleOperators=function(e){var t,r,n=e.$el.find(c.selectors.operator_container).empty();e.filter&&(t=this.getOperators(e.filter),r=d(d.parseHTML(this.getRuleOperatorSelect(e,t))),n.html(r),e.filter.default_operator?e.__.operator=this.getOperatorByType(e.filter.default_operator):e.__.operator=t[0],e.$el.find(c.selectors.rule_operator).val(e.operator.type),this.trigger("afterCreateRuleOperators",e,t),this.applyRuleFlags(e))},c.prototype.createRuleInput=function(e){var t=e.$el.find(c.selectors.value_container).empty();if(e.__.value=void 0,e.filter&&e.operator&&0!==e.operator.nb_inputs){for(var r=this,n=d(),i=e.filter,o=0;o<e.operator.nb_inputs;o++){var l=d(d.parseHTML(d.trim(this.getRuleInput(e,o))));0<o&&t.append(this.settings.inputs_separator),t.append(l),n=n.add(l)}t.css("display",""),n.on("change "+(i.input_event||""),function(){e._updating_input||(e._updating_value=!0,e.value=r.getRuleInputValue(e),e._updating_value=!1)}),i.plugin&&n[i.plugin](i.plugin_config||{}),this.trigger("afterCreateRuleInput",e),void 0!==i.default_value?e.value=i.default_value:(e._updating_value=!0,e.value=r.getRuleInputValue(e),e._updating_value=!1),this.applyRuleFlags(e)}},c.prototype.updateRuleFilter=function(e,t){this.createRuleOperators(e),this.createRuleInput(e),e.$el.find(c.selectors.rule_filter).val(e.filter?e.filter.id:"-1"),t&&e.filter&&t.id!==e.filter.id&&(e.data=void 0),this.trigger("afterUpdateRuleFilter",e,t),this.trigger("rulesChanged")},c.prototype.updateRuleOperator=function(e,t){var r=e.$el.find(c.selectors.value_container);e.operator&&0!==e.operator.nb_inputs?(r.css("display",""),!r.is(":empty")&&t&&e.operator.nb_inputs===t.nb_inputs&&e.operator.optgroup===t.optgroup||this.createRuleInput(e)):(r.hide(),e.__.value=void 0),e.operator&&(e.$el.find(c.selectors.rule_operator).val(e.operator.type),e.__.value=this.getRuleInputValue(e)),this.trigger("afterUpdateRuleOperator",e,t),this.trigger("rulesChanged")},c.prototype.updateRuleValue=function(e,t){e._updating_value||this.setRuleInputValue(e,e.value),this.trigger("afterUpdateRuleValue",e,t),this.trigger("rulesChanged")},c.prototype.applyRuleFlags=function(e){var t=e.flags,r=c.selectors;e.$el.find(r.rule_filter).prop("disabled",t.filter_readonly),e.$el.find(r.rule_operator).prop("disabled",t.operator_readonly),e.$el.find(r.rule_value).prop("disabled",t.value_readonly),t.no_delete&&e.$el.find(r.delete_rule).remove(),this.trigger("afterApplyRuleFlags",e)},c.prototype.applyGroupFlags=function(e){var t=e.flags,r=c.selectors;e.$el.find(">"+r.group_condition).prop("disabled",t.condition_readonly).parent().toggleClass("readonly",t.condition_readonly),t.no_add_rule&&e.$el.find(r.add_rule).remove(),t.no_add_group&&e.$el.find(r.add_group).remove(),t.no_delete&&e.$el.find(r.delete_group).remove(),this.trigger("afterApplyGroupFlags",e)},c.prototype.clearErrors=function(e){(e=e||this.model.root)&&(e.error=null,e instanceof a)&&e.each(function(e){e.error=null},function(e){this.clearErrors(e)},this)},c.prototype.updateError=function(e){var t;this.settings.display_errors&&(null===e.error?e.$el.removeClass("has-error"):(t=this.translate("errors",e.error[0]),t=f.fmt(t,e.error.slice(1)),t=this.change("displayError",t,e.error,e),e.$el.addClass("has-error").find(c.selectors.error_container).eq(0).attr("title",t)))},c.prototype.triggerValidationError=function(e,t,r){d.isArray(t)||(t=[t]),this.trigger("validationError",e,t,r).isDefaultPrevented()||(e.error=t)},c.prototype.destroy=function(){this.trigger("beforeDestroy"),this.status.generated_id&&this.$el.removeAttr("id"),this.clear(),this.model=null,this.$el.off(".queryBuilder").removeClass("query-builder").removeData("queryBuilder"),delete this.$el[0].queryBuilder},c.prototype.reset=function(){this.trigger("beforeReset").isDefaultPrevented()||(this.status.group_id=1,this.status.rule_id=0,this.model.root.empty(),this.model.root.data=void 0,this.model.root.flags=d.extend({},this.settings.default_group_flags),this.model.root.condition=this.settings.default_condition,this.addRule(this.model.root),this.trigger("afterReset"),this.trigger("rulesChanged"))},c.prototype.clear=function(){this.trigger("beforeClear").isDefaultPrevented()||(this.status.group_id=0,this.status.rule_id=0,this.model.root&&(this.model.root.drop(),this.model.root=null),this.trigger("afterClear"),this.trigger("rulesChanged"))},c.prototype.setOptions=function(e){d.each(e,function(e,t){-1!==c.modifiable_options.indexOf(e)&&(this.settings[e]=t)}.bind(this))},c.prototype.getModel=function(e){return e?e instanceof i?e:d(e).data("queryBuilderModel"):this.model.root},c.prototype.validate=function(i){i=d.extend({skip_empty:!1},i),this.clearErrors();var o=this,e=function t(e){var r=0,n=0;return e.each(function(e){if(e.filter||!i.skip_empty)if(e.filter)if(e.operator){if(0!==e.operator.nb_inputs){var t=o.validateValue(e,e.value);if(!0!==t)return o.triggerValidationError(e,t,e.value),void n++}r++}else o.triggerValidationError(e,"no_operator",null),n++;else o.triggerValidationError(e,"no_filter",null),n++},function(e){e=t(e);!0===e?r++:!1===e&&n++}),!(0<n)&&(0===r&&!e.isRoot()&&i.skip_empty?null:!!(0!==r||o.settings.allow_empty&&e.isRoot())||(o.triggerValidationError(e,"empty_group",null),!1))}(this.model.root);return this.change("validate",e)},c.prototype.getRules=function(i){i=d.extend({get_flags:!1,allow_invalid:!1,skip_empty:!1},i);var o,e,t=this.validate(i);return t||i.allow_invalid?((e=function t(e){var r,n={condition:e.condition,rules:[]};return e.data&&(n.data=d.extendext(!0,"replace",{},e.data)),i.get_flags&&(r=o.getGroupFlags(e.flags,"all"===i.get_flags),d.isEmptyObject(r)||(n.flags=r)),e.each(function(e){var t,r;!e.filter&&i.skip_empty||(t=null,e.operator&&0===e.operator.nb_inputs||(t=e.value),t={id:e.filter?e.filter.id:null,field:e.filter?e.filter.field:null,type:e.filter?e.filter.type:null,input:e.filter?e.filter.input:null,operator:e.operator?e.operator.type:null,value:t},(e.filter&&e.filter.data||e.data)&&(t.data=d.extendext(!0,"replace",{},e.filter?e.filter.data:{},e.data)),i.get_flags&&(r=o.getRuleFlags(e.flags,"all"===i.get_flags),d.isEmptyObject(r)||(t.flags=r)),n.rules.push(o.change("ruleToJson",t,e)))},function(e){e=t(e);0===e.rules.length&&i.skip_empty||n.rules.push(e)},this),o.change("groupToJson",n,e)}((o=this).model.root)).valid=t,this.change("getRules",e)):null},c.prototype.setRules=function(e,i){i=d.extend({allow_invalid:!1},i),(e=d.isArray(e)?{condition:this.settings.default_condition,rules:e}:e)&&e.rules&&(0!==e.rules.length||this.settings.allow_empty)||f.error("RulesParse","Incorrect data object passed"),this.clear(),this.setRoot(!1,e.data,this.parseGroupFlags(e)),e=this.change("setRules",e,i);var o=this;!function r(e,n){null!==n&&(void 0===e.condition?e.condition=o.settings.default_condition:-1==o.settings.conditions.indexOf(e.condition)&&(f.error(!i.allow_invalid,"UndefinedCondition",'Invalid condition "{0}"',e.condition),e.condition=o.settings.default_condition),n.condition=e.condition,e.rules.forEach(function(e){var t;void 0!==e.rules?-1!==o.settings.allow_groups&&o.settings.allow_groups<n.level?(f.error(!i.allow_invalid,"RulesParse","No more than {0} groups are allowed",o.settings.allow_groups),o.reset()):null!==(t=o.addGroup(n,!1,e.data,o.parseGroupFlags(e)))&&r(e,t):(e.empty||(void 0===e.id&&(f.error(!i.allow_invalid,"RulesParse","Missing rule field id"),e.empty=!0),void 0===e.operator&&(e.operator="equal")),null!==(t=o.addRule(n,e.data,o.parseRuleFlags(e)))&&(e.empty||(t.filter=o.getFilterById(e.id,!i.allow_invalid)),t.filter&&(t.operator=o.getOperatorByType(e.operator,!i.allow_invalid),t.operator||(t.operator=o.getOperators(t.filter)[0])),t.operator&&0!==t.operator.nb_inputs&&(void 0!==e.value?t.value=e.value:void 0!==t.filter.default_value&&(t.value=t.filter.default_value)),o.change("jsonToRule",t,e)!=t)&&f.error("RulesParse","Plugin tried to change rule reference"))}),o.change("jsonToGroup",n,e)!=n)&&f.error("RulesParse","Plugin tried to change group reference")}(e,this.model.root),this.trigger("afterSetRules")},c.prototype.validateValue=function(e,t){var r=e.filter.validation||{},n=!0,n=r.callback?r.callback.call(this,t,e):this._validateValue(e,t);return this.change("validateValue",n,t,e)},c.prototype._validateValue=function(e,t){var r,n=e.filter,i=e.operator,o=n.validation||{},l=!0;1===e.operator.nb_inputs&&(t=[t]);for(var s=0;s<i.nb_inputs;s++){if(!i.multiple&&d.isArray(t[s])&&1<t[s].length){l=["operator_not_multiple",i.type,this.translate("operators",i.type)];break}switch(n.input){case"radio":void 0!==t[s]&&0!==t[s].length||o.allow_empty_value||(l=["radio_empty"]);break;case"checkbox":void 0!==t[s]&&0!==t[s].length||o.allow_empty_value||(l=["checkbox_empty"]);break;case"select":!(void 0===t[s]||0===t[s].length||n.placeholder&&t[s]==n.placeholder_value)||o.allow_empty_value||(l=["select_empty"]);break;default:for(var a=d.isArray(t[s])?t[s]:[t[s]],u=0;u<a.length;u++){switch(c.types[n.type]){case"string":void 0===a[u]||0===a[u].length?o.allow_empty_value||(l=["string_empty"]):void 0!==o.min&&a[u].length<parseInt(o.min)?l=[this.getValidationMessage(o,"min","string_exceed_min_length"),o.min]:void 0!==o.max&&a[u].length>parseInt(o.max)?l=[this.getValidationMessage(o,"max","string_exceed_max_length"),o.max]:o.format&&("string"==typeof o.format&&(o.format=new RegExp(o.format)),!o.format.test(a[u]))&&(l=[this.getValidationMessage(o,"format","string_invalid_format"),o.format]);break;case"number":if(void 0===a[u]||0===a[u].length)o.allow_empty_value||(l=["number_nan"]);else if(isNaN(a[u]))l=["number_nan"];else{if("integer"==n.type){if(parseInt(a[u])!=a[u]){l=["number_not_integer"];break}}else if(parseFloat(a[u])!=a[u]){l=["number_not_double"];break}if(void 0!==o.min&&a[u]<parseFloat(o.min))l=[this.getValidationMessage(o,"min","number_exceed_min"),o.min];else if(void 0!==o.max&&a[u]>parseFloat(o.max))l=[this.getValidationMessage(o,"max","number_exceed_max"),o.max];else if(void 0!==o.step&&"any"!==o.step){var p=(a[u]/o.step).toPrecision(14);if(parseInt(p)!=p){l=[this.getValidationMessage(o,"step","number_wrong_step"),o.step];break}}}break;case"datetime":if(void 0===a[u]||0===a[u].length)o.allow_empty_value||(l=["datetime_empty"]);else if(o.format){"moment"in window||f.error("MissingLibrary","MomentJS is required for Date/Time validation. Get it here http://momentjs.com");p=moment(a[u],o.format);if(!p.isValid()){l=[this.getValidationMessage(o,"format","datetime_invalid"),o.format];break}if(o.min&&p<moment(o.min,o.format)){l=[this.getValidationMessage(o,"min","datetime_exceed_min"),o.min];break}if(o.max&&p>moment(o.max,o.format)){l=[this.getValidationMessage(o,"max","datetime_exceed_max"),o.max];break}}break;case"boolean":void 0===a[u]||0===a[u].length?o.allow_empty_value||(l=["boolean_not_valid"]):"true"!==(r=(""+a[u]).trim().toLowerCase())&&"false"!==r&&"1"!==r&&"0"!==r&&1!==a[u]&&0!==a[u]&&(l=["boolean_not_valid"])}if(!0!==l)break}}if(!0!==l)break}if(("between"===e.operator.type||"not_between"===e.operator.type)&&2===t.length)switch(c.types[n.type]){case"number":t[0]>t[1]&&(l=["number_between_invalid",t[0],t[1]]);break;case"datetime":o.format&&("moment"in window||f.error("MissingLibrary","MomentJS is required for Date/Time validation. Get it here http://momentjs.com"),moment(t[0],o.format).isAfter(moment(t[1],o.format)))&&(l=["datetime_between_invalid",t[0],t[1]])}return l},c.prototype.nextGroupId=function(){return this.status.id+"_group_"+this.status.group_id++},c.prototype.nextRuleId=function(){return this.status.id+"_rule_"+this.status.rule_id++},c.prototype.getOperators=function(r){"string"==typeof r&&(r=this.getFilterById(r));for(var e=[],t=0,n=this.operators.length;t<n;t++){if(r.operators){if(-1==r.operators.indexOf(this.operators[t].type))continue}else if(-1==this.operators[t].apply_to.indexOf(c.types[r.type]))continue;e.push(this.operators[t])}return r.operators&&e.sort(function(e,t){return r.operators.indexOf(e.type)-r.operators.indexOf(t.type)}),this.change("getOperators",e,r)},c.prototype.getFilterById=function(e,t){if("-1"!=e){for(var r=0,n=this.filters.length;r<n;r++)if(this.filters[r].id==e)return this.filters[r];f.error(!1!==t,"UndefinedFilter",'Undefined filter "{0}"',e)}return null},c.prototype.getOperatorByType=function(e,t){if("-1"!=e){for(var r=0,n=this.operators.length;r<n;r++)if(this.operators[r].type==e)return this.operators[r];f.error(!1!==t,"UndefinedOperator",'Undefined operator "{0}"',e)}return null},c.prototype.getRuleInputValue=function(e){var t=e.filter,r=e.operator,n=[];if(t.valueGetter)n=t.valueGetter.call(this,e);else{for(var i=e.$el.find(c.selectors.value_container),o=0;o<r.nb_inputs;o++){var l,s=f.escapeElementId(e.id+"_value_"+o);switch(t.input){case"radio":n.push(i.find("[name="+s+"]:checked").val());break;case"checkbox":l=[],i.find("[name="+s+"]:checked").each(function(){l.push(d(this).val())}),n.push(l);break;case"select":t.multiple?(l=[],i.find("[name="+s+"] option:selected").each(function(){l.push(d(this).val())}),n.push(l)):n.push(i.find("[name="+s+"] option:selected").val());break;default:n.push(i.find("[name="+s+"]").val())}}n=n.map(function(e){return r.multiple&&t.value_separator&&"string"==typeof e&&(e=e.split(t.value_separator)),d.isArray(e)?e.map(function(e){return f.changeType(e,t.type)}):f.changeType(e,t.type)}),1===r.nb_inputs&&(n=n[0]),t.valueParser&&(n=t.valueParser.call(this,e,n))}return this.change("getRuleValue",n,e)},c.prototype.setRuleInputValue=function(e,t){var r=e.filter,n=e.operator;if(r&&n){if(e._updating_input=!0,r.valueSetter)r.valueSetter.call(this,e,t);else{var i=e.$el.find(c.selectors.value_container);1==n.nb_inputs&&(t=[t]);for(var o=0;o<n.nb_inputs;o++){var l=f.escapeElementId(e.id+"_value_"+o);switch(r.input){case"radio":i.find("[name="+l+'][value="'+t[o]+'"]').prop("checked",!0).trigger("change");break;case"checkbox":d.isArray(t[o])||(t[o]=[t[o]]),t[o].forEach(function(e){i.find("[name="+l+'][value="'+e+'"]').prop("checked",!0).trigger("change")});break;default:n.multiple&&r.value_separator&&d.isArray(t[o])&&(t[o]=t[o].join(r.value_separator)),i.find("[name="+l+"]").val(t[o]).trigger("change")}}}e._updating_input=!1}},c.prototype.parseRuleFlags=function(e){var t=d.extend({},this.settings.default_rule_flags);return e.readonly&&d.extend(t,{filter_readonly:!0,operator_readonly:!0,value_readonly:!0,no_delete:!0}),e.flags&&d.extend(t,e.flags),this.change("parseRuleFlags",t,e)},c.prototype.getRuleFlags=function(r,e){var n;return e?d.extend({},r):(n={},d.each(this.settings.default_rule_flags,function(e,t){r[e]!==t&&(n[e]=r[e])}),n)},c.prototype.parseGroupFlags=function(e){var t=d.extend({},this.settings.default_group_flags);return e.readonly&&d.extend(t,{condition_readonly:!0,no_add_rule:!0,no_add_group:!0,no_delete:!0}),e.flags&&d.extend(t,e.flags),this.change("parseGroupFlags",t,e)},c.prototype.getGroupFlags=function(r,e){var n;return e?d.extend({},r):(n={},d.each(this.settings.default_group_flags,function(e,t){r[e]!==t&&(n[e]=r[e])}),n)},c.prototype.translate=function(e,t){var r;return t||(t=e,e=void 0),r="object"==typeof t?t[this.settings.lang_code]||t.en:(e?this.lang[e]:this.lang)[t]||t,this.change("translate",r,t,e)},c.prototype.getValidationMessage=function(e,t,r){return e.messages&&e.messages[t]||r},c.templates.group=({group_id:t,level:e,conditions:r,icons:n,settings:i,translate:o})=>`
<div id="${t}" class="rules-group-container">
  <div class="rules-group-header">
    <div class="btn-group pull-right group-actions">
      <button type="button" class="btn btn-xs btn-success" data-add="rule">
        <i class="${n}"></i> ${o("add_rule")}
      </button>
      ${-1===i.allow_groups||i.allow_groups>=e?`
        <button type="button" class="btn btn-xs btn-success" data-add="group">
          <i class="${n.add_group}"></i> ${o("add_group")}
        </button>
      `:""}
      ${1<e?`
        <button type="button" class="btn btn-xs btn-danger" data-delete="group">
          <i class="${n.remove_group}"></i> ${o("delete_group")}
        </button>
      `:""}
    </div>
    <div class="btn-group group-conditions">
      ${r.map(e=>`
        <label class="btn btn-xs btn-primary">
          <input type="radio" name="${t}_cond" value="${e}"> ${o("conditions",e)}
        </label>
      `).join("\n")}
    </div>
    ${i.display_errors?`
      <div class="error-container"><i class="${n.error}"></i></div>
    `:""}
  </div>
  <div class=rules-group-body>
    <div class=rules-list></div>
  </div>
</div>`,c.templates.rule=({rule_id:e,icons:t,settings:r,translate:n})=>`
<div id="${e}" class="rule-container">
  <div class="rule-header">
    <div class="btn-group pull-right rule-actions">
      <button type="button" class="btn btn-xs btn-danger" data-delete="rule">
        <i class="${t.remove_rule}"></i> ${n("delete_rule")}
      </button>
    </div>
  </div>
  ${r.display_errors?`
    <div class="error-container"><i class="${t.error}"></i></div>
  `:""}
  <div class="rule-filter-container"></div>
  <div class="rule-operator-container"></div>
  <div class="rule-value-container"></div>
</div>`,c.templates.filterSelect=({rule:e,filters:t,settings:r,translate:n})=>{let i=null;return`
<select class="form-control" name="${e.id}_filter">
  ${r.display_empty_filter?`
    <option value="-1">${r.select_placeholder}</option>
  `:""}
  ${t.map(e=>`
    ${i!==e.optgroup?`
      ${null!==i?"</optgroup>":""}
      ${null!==(i=e.optgroup)?`
        <optgroup label="${n(r.optgroups[i])}">
      `:""}
    `:""}
    <option value="${e.id}" ${e.icon?`data-icon="${e.icon}"`:""}>${n(e.label)}</option>
  `).join("")}
  ${null!==i?"</optgroup>":""}
</select>`},c.templates.operatorSelect=({rule:e,operators:t,settings:r,translate:n})=>{let i=null;return`
${1===t.length?`
<span>
${n("operators",t[0].type)}
</span>
`:""}
<select class="form-control ${1===t.length?"hide":""}" name="${e.id}_operator">
  ${t.map(e=>`
    ${i!==e.optgroup?`
      ${null!==i?"</optgroup>":""}
      ${null!==(i=e.optgroup)?`
        <optgroup label="${n(r.optgroups[i])}">
      `:""}
    `:""}
    <option value="${e.type}" ${e.icon?`data-icon="${e.icon}"`:""}>${n("operators",e.type)}</option>
  `).join("")}
  ${null!==i?"</optgroup>":""}
</select>`},c.templates.ruleValueSelect=({name:e,rule:t,settings:r,translate:n})=>{let i=null;return`
<select class="form-control" name="${e}" ${t.filter.multiple?"multiple":""}>
  ${t.filter.placeholder?`
    <option value="${t.filter.placeholder_value}" disabled selected>${t.filter.placeholder}</option>
  `:""}
  ${t.filter.values.map(e=>`
    ${i!==e.optgroup?`
      ${null!==i?"</optgroup>":""}
      ${null!==(i=e.optgroup)?`
        <optgroup label="${n(r.optgroups[i])}">
      `:""}
    `:""}
    <option value="${e.value}">${e.label}</option>
  `).join("")}
  ${null!==i?"</optgroup>":""}
</select>`},c.prototype.getGroupTemplate=function(e,t){e=this.templates.group({builder:this,group_id:e,level:t,conditions:this.settings.conditions,icons:this.icons,settings:this.settings,translate:this.translate.bind(this)}).trim();return this.change("getGroupTemplate",e,t)},c.prototype.getRuleTemplate=function(e){e=this.templates.rule({builder:this,rule_id:e,icons:this.icons,settings:this.settings,translate:this.translate.bind(this)}).trim();return this.change("getRuleTemplate",e)},c.prototype.getRuleFilterSelect=function(e,t){var r=this.templates.filterSelect({builder:this,rule:e,filters:t,icons:this.icons,settings:this.settings,translate:this.translate.bind(this)}).trim();return this.change("getRuleFilterSelect",r,e,t)},c.prototype.getRuleOperatorSelect=function(e,t){var r=this.templates.operatorSelect({builder:this,rule:e,operators:t,icons:this.icons,settings:this.settings,translate:this.translate.bind(this)}).trim();return this.change("getRuleOperatorSelect",r,e,t)},c.prototype.getRuleValueSelect=function(e,t){var r=this.templates.ruleValueSelect({builder:this,name:e,rule:t,icons:this.icons,settings:this.settings,translate:this.translate.bind(this)}).trim();return this.change("getRuleValueSelect",r,e,t)},c.prototype.getRuleInput=function(e,t){var r=e.filter,n=e.filter.validation||{},i=e.id+"_value_"+t,o=r.vertical?" class=block":"",l="",s=Array.isArray(r.placeholder)?r.placeholder[t]:r.placeholder;if("function"==typeof r.input)l=r.input.call(this,e,i);else switch(r.input){case"radio":case"checkbox":f.iterateOptions(r.values,function(e,t){l+="<label"+o+'><input type="'+r.input+'" name="'+i+'" value="'+e+'"> '+t+"</label> "});break;case"select":l=this.getRuleValueSelect(i,e);break;case"textarea":l+='<textarea class="form-control" name="'+i+'"',r.size&&(l+=' cols="'+r.size+'"'),r.rows&&(l+=' rows="'+r.rows+'"'),void 0!==n.min&&(l+=' minlength="'+n.min+'"'),void 0!==n.max&&(l+=' maxlength="'+n.max+'"'),s&&(l+=' placeholder="'+s+'"'),l+="></textarea>";break;case"number":l+='<input class="form-control" type="number" name="'+i+'"',void 0!==n.step&&(l+=' step="'+n.step+'"'),void 0!==n.min&&(l+=' min="'+n.min+'"'),void 0!==n.max&&(l+=' max="'+n.max+'"'),s&&(l+=' placeholder="'+s+'"'),r.size&&(l+=' size="'+r.size+'"'),l+=">";break;default:l+='<input class="form-control" type="text" name="'+i+'"',s&&(l+=' placeholder="'+s+'"'),"string"===r.type&&void 0!==n.min&&(l+=' minlength="'+n.min+'"'),"string"===r.type&&void 0!==n.max&&(l+=' maxlength="'+n.max+'"'),r.size&&(l+=' size="'+r.size+'"'),l+=">"}return this.change("getRuleInput",l,e,i)};var f={};function r(){this.root=null,this.$=d(this)}(c.utils=f).iterateOptions=function(e,r){e&&(d.isArray(e)?e.forEach(function(e){d.isPlainObject(e)?"value"in e?r(e.value,e.label||e.value,e.optgroup):d.each(e,function(e,t){return r(e,t),!1}):r(e,e)}):d.each(e,function(e,t){r(e,t)}))},f.fmt=function(e,r){return Array.isArray(r)||(r=Array.prototype.slice.call(arguments,1)),e.replace(/{([0-9]+)}/g,function(e,t){return r[parseInt(t)]})},f.error=function(){var e=0,t="boolean"!=typeof arguments[e]||arguments[e++],r=arguments[e++],n=arguments[e++],e=Array.isArray(arguments[e])?arguments[e]:Array.prototype.slice.call(arguments,e);if(t)throw(t=new Error(f.fmt(n,e))).name=r+"Error",t.args=e,t;console.error(r+"Error: "+f.fmt(n,e))},f.changeType=function(e,t){if(""!==e&&void 0!==e)switch(t){case"integer":return"string"!=typeof e||/^-?\d+$/.test(e)?parseInt(e):e;case"double":return"string"!=typeof e||/^-?\d+\.?\d*$/.test(e)?parseFloat(e):e;case"boolean":return"string"!=typeof e||/^(0|1|true|false){1}$/i.test(e)?!0===e||1===e||"true"===e.toLowerCase()||"1"===e:e;default:return e}},f.escapeString=function(e,t){return"string"==typeof e&&(e=e.replace(/[\0\n\r\b\\\'\"]/g,function(e){switch(e){case"\0":return"\\0";case"\n":return"\\n";case"\r":return"\\r";case"\b":return"\\b";case"'":return"''";default:return"\\"+e}}).replace(/\t/g,"\\t").replace(/\x1a/g,"\\Z"),t)?e.replace(new RegExp("["+t+"]","g"),function(e){return"\\"+e}):e},f.escapeRegExp=function(e){return e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")},f.escapeElementId=function(e){return e&&e.replace(/(\\)?([:.\[\],])/g,function(e,t,r){return t?e:"\\"+r})},f.groupSort=function(e,r){var n=[],i=[];return e.forEach(function(e){var t;!e[r]||-1==(t=n.lastIndexOf(e[r]))?t=n.length:t++,n.splice(t,0,e[r]),i.splice(t,0,e)}),i},f.defineModelProperties=function(e,t){t.forEach(function(r){Object.defineProperty(e.prototype,r,{enumerable:!0,get:function(){return this.__[r]},set:function(e){var t=null!==this.__[r]&&"object"==typeof this.__[r]?d.extend({},this.__[r]):this.__[r];this.__[r]=e,null!==this.model&&this.model.trigger("update",this,r,e,t)}})})},d.extend(r.prototype,{trigger:function(e){e=new d.Event(e);return this.$.triggerHandler(e,Array.prototype.slice.call(arguments,1)),e},on:function(){return this.$.on.apply(this.$,Array.prototype.slice.call(arguments)),this},off:function(){return this.$.off.apply(this.$,Array.prototype.slice.call(arguments)),this},once:function(){return this.$.one.apply(this.$,Array.prototype.slice.call(arguments)),this}});var i=function(e,t){if(!(this instanceof i))return new i(e,t);Object.defineProperty(this,"__",{value:{}}),t.data("queryBuilderModel",this),this.__.level=1,this.__.error=null,this.__.flags={},this.__.data=void 0,this.$el=t,this.id=t[0].id,this.model=null,this.parent=e},a=(f.defineModelProperties(i,["level","error","data","flags"]),Object.defineProperty(i.prototype,"parent",{enumerable:!0,get:function(){return this.__.parent},set:function(e){this.__.parent=e,this.level=null===e?1:e.level+1,this.model=null===e?null:e.model}}),i.prototype.isRoot=function(){return 1===this.level},i.prototype.getPos=function(){return this.isRoot()?-1:this.parent.getNodePos(this)},i.prototype.drop=function(){var e=this.model;this.parent&&this.parent.removeNode(this),this.$el.removeData("queryBuilderModel"),null!==e&&e.trigger("drop",this)},i.prototype.moveAfter=function(e){this.isRoot()||this.move(e.parent,e.getPos()+1)},i.prototype.moveAtBegin=function(e){this.isRoot()||(void 0===e&&(e=this.parent),this.move(e,0))},i.prototype.moveAtEnd=function(e){this.isRoot()||(void 0===e&&(e=this.parent),this.move(e,0===e.length()?0:e.length()-1))},i.prototype.move=function(e,t){this.isRoot()||("number"==typeof e&&(t=e,e=this.parent),this.parent.removeNode(this),e.insertNode(this,t,!1),null!==this.model&&this.model.trigger("move",this,e,t))},function(e,t){if(!(this instanceof a))return new a(e,t);i.call(this,e,t),this.rules=[],this.__.condition=null}),l=(a.prototype=Object.create(i.prototype),a.prototype.constructor=a,f.defineModelProperties(a,["condition"]),a.prototype.empty=function(){this.each("reverse",function(e){e.drop()},function(e){e.drop()})},a.prototype.drop=function(){this.empty(),i.prototype.drop.call(this)},a.prototype.length=function(){return this.rules.length},a.prototype.insertNode=function(e,t,r){return void 0===t&&(t=this.length()),this.rules.splice(t,0,e),e.parent=this,r&&null!==this.model&&this.model.trigger("add",this,e,t),e},a.prototype.addGroup=function(e,t){return this.insertNode(new a(this,e),t,!0)},a.prototype.addRule=function(e,t){return this.insertNode(new l(this,e),t,!0)},a.prototype.removeNode=function(e){var t=this.getNodePos(e);-1!==t&&(e.parent=null,this.rules.splice(t,1))},a.prototype.getNodePos=function(e){return this.rules.indexOf(e)},a.prototype.each=function(e,t,r,n){"boolean"!=typeof e&&"string"!=typeof e&&(n=r,r=t,t=e,e=!1),n=void 0===n?null:n;for(var i=e?this.rules.length-1:0,o=e?0:this.rules.length-1,l=e?-1:1,s=!1;(e?o<=i:i<=o)&&(this.rules[i]instanceof a?r&&(s=!1===r.call(n,this.rules[i])):t&&(s=!1===t.call(n,this.rules[i])),!s);i+=l);return!s},a.prototype.contains=function(t,e){return-1!==this.getNodePos(t)||!!e&&!this.each(function(){return!0},function(e){return!e.contains(t,!0)})},function(e,t){if(!(this instanceof l))return new l(e,t);i.call(this,e,t),this._updating_value=!1,this._updating_input=!1,this.__.filter=null,this.__.operator=null,this.__.value=void 0});function u(e,t,r){var n,i=c.selectors,o=t.closest(i.rule_container);(n=o.length?"moveAfter":n)||(o=t.closest(i.group_header)).length&&(o=t.closest(i.group_container),n="moveAtBegin"),n||(o=t.closest(i.group_container)).length&&(n="moveAtEnd"),n&&(e[n](r.getModel(o)),r)&&e instanceof l&&r.setRuleInputValue(e,e.value)}function n(e){return e.match(/(question_mark|numbered|named)(?:\((.)\))?/)||[null,"question_mark",void 0]}return l.prototype=Object.create(i.prototype),l.prototype.constructor=l,f.defineModelProperties(l,["filter","operator","value"]),l.prototype.isRoot=function(){return!1},c.Group=a,c.Rule=l,d.fn.queryBuilder=function(e){0===this.length&&f.error("Config","No target defined"),1<this.length&&f.error("Config","Unable to initialize on multiple target");var t,r=this.data("queryBuilder"),n="object"==typeof e&&e||{};return(r||"destroy"!=e)&&(r||(t=new c(this,n),this.data("queryBuilder",t),t.init(n.rules)),"string"==typeof e)?r[e].apply(r,Array.prototype.slice.call(arguments,1)):this},d.fn.queryBuilder.constructor=c,d.fn.queryBuilder.defaults=c.defaults,d.fn.queryBuilder.extend=c.extend,d.fn.queryBuilder.define=c.define,d.fn.queryBuilder.regional=c.regional,c.define("bt-checkbox",function(u){"glyphicons"==u.font&&this.$el.addClass("bt-checkbox-glyphicons"),this.on("getRuleInput.filter",function(i,e,o){var l,s,a=e.filter;"radio"!==a.input&&"checkbox"!==a.input||a.plugin||(i.value="",a.colors||(a.colors={}),a.color&&(a.colors._def_=a.color),l=a.vertical?' style="display:block"':"",s=0,f.iterateOptions(a.values,function(e,t){var r=a.colors[e]||a.colors._def_||u.color,n=o+"_"+s++;i.value+="<div"+l+' class="'+a.input+" "+a.input+"-"+r+'">   <input type="'+a.input+'" name="'+o+'" id="'+n+'" value="'+e+'">   <label for="'+n+'">'+t+"</label> </div>"}))})},{font:"glyphicons",color:"default"}),c.define("bt-selectpicker",function(r){d.fn.selectpicker&&d.fn.selectpicker.Constructor||f.error("MissingLibrary",'Bootstrap Select is required to use "bt-selectpicker" plugin. Get it here: http://silviomoreto.github.io/bootstrap-select');var n=c.selectors;this.on("afterCreateRuleFilters",function(e,t){t.$el.find(n.rule_filter).removeClass("form-control").selectpicker(r)}),this.on("afterCreateRuleOperators",function(e,t){t.$el.find(n.rule_operator).removeClass("form-control").selectpicker(r)}),this.on("afterUpdateRuleFilter",function(e,t){t.$el.find(n.rule_filter).selectpicker("render")}),this.on("afterUpdateRuleOperator",function(e,t){t.$el.find(n.rule_operator).selectpicker("render")}),this.on("beforeDeleteRule",function(e,t){t.$el.find(n.rule_filter).selectpicker("destroy"),t.$el.find(n.rule_operator).selectpicker("destroy")})},{container:"body",style:"btn-inverse btn-xs",width:"auto",showIcon:!1}),c.define("bt-tooltip-errors",function(n){d.fn.tooltip&&d.fn.tooltip.Constructor&&d.fn.tooltip.Constructor.prototype.fixTitle||f.error("MissingLibrary",'Bootstrap Tooltip is required to use "bt-tooltip-errors" plugin. Get it here: http://getbootstrap.com');var i=this;this.on("getRuleTemplate.filter getGroupTemplate.filter",function(e){var t=d(d.parseHTML(e.value));t.find(c.selectors.error_container).attr("data-toggle","tooltip"),e.value=t.prop("outerHTML")}),this.model.on("update",function(e,t,r){"error"==r&&i.settings.display_errors&&t.$el.find(c.selectors.error_container).eq(0).tooltip(n).tooltip("hide").tooltip("fixTitle")})},{placement:"right"}),c.extend({setFilters:function(e,t){var r=this,n=(void 0===t&&(t=e,e=!1),t=this.checkFilters(t),(t=this.change("setFilters",t)).map(function(e){return e.id}));if(e||!function e(t){t.each(function(e){e.filter&&-1===n.indexOf(e.filter.id)&&f.error("ChangeFilter",'A rule is using filter "{0}"',e.filter.id)},e)}(this.model.root),this.filters=t,!function e(t){t.each(!0,function(e){e.filter&&-1===n.indexOf(e.filter.id)?(e.drop(),r.trigger("rulesChanged")):(r.createRuleFilters(e),e.$el.find(c.selectors.rule_filter).val(e.filter?e.filter.id:"-1"),r.trigger("afterUpdateRuleFilter",e))},e)}(this.model.root),this.settings.plugins&&(this.settings.plugins["unique-filter"]&&this.updateDisabledFilters(),this.settings.plugins["bt-selectpicker"])&&this.$el.find(c.selectors.rule_filter).selectpicker("render"),this.settings.default_filter)try{this.getFilterById(this.settings.default_filter)}catch(e){this.settings.default_filter=null}this.trigger("afterSetFilters",t)},addFilter:function(e,r){void 0===r||"#end"==r?r=this.filters.length:"#start"==r&&(r=0),d.isArray(e)||(e=[e]);var t=d.extend(!0,[],this.filters);parseInt(r)==r||this.filters.some(function(e,t){if(e.id==r)return r=t+1,!0})?Array.prototype.splice.apply(t,[r,0].concat(e)):Array.prototype.push.apply(t,e),this.setFilters(t)},removeFilter:function(t,e){var r=d.extend(!0,[],this.filters);"string"==typeof t&&(t=[t]),r=r.filter(function(e){return-1===t.indexOf(e.id)}),this.setFilters(e,r)}}),c.define("chosen-selectpicker",function(r){d.fn.chosen||f.error("MissingLibrary",'chosen is required to use "chosen-selectpicker" plugin. Get it here: https://github.com/harvesthq/chosen'),this.settings.plugins["bt-selectpicker"]&&f.error("Conflict","bt-selectpicker is already selected as the dropdown plugin. Please remove chosen-selectpicker from the plugin list");var n=c.selectors;this.on("afterCreateRuleFilters",function(e,t){t.$el.find(n.rule_filter).removeClass("form-control").chosen(r)}),this.on("afterCreateRuleOperators",function(e,t){1<e.builder.getOperators(t.filter).length&&t.$el.find(n.rule_operator).removeClass("form-control").chosen(r)}),this.on("afterUpdateRuleFilter",function(e,t){t.$el.find(n.rule_filter).trigger("chosen:updated")}),this.on("afterUpdateRuleOperator",function(e,t){t.$el.find(n.rule_operator).trigger("chosen:updated")}),this.on("beforeDeleteRule",function(e,t){t.$el.find(n.rule_filter).chosen("destroy"),t.$el.find(n.rule_operator).chosen("destroy")})}),c.define("filter-description",function(n){"inline"===n.mode?this.on("afterUpdateRuleFilter afterUpdateRuleOperator",function(e,t){var r=t.$el.find("p.filter-description"),e=e.builder.getFilterDescription(t.filter,t);e?(0===r.length?(r=d(d.parseHTML('<p class="filter-description"></p>'))).appendTo(t.$el):r.css("display",""),r.html('<i class="'+n.icon+'"></i> '+e)):r.hide()}):"popover"===n.mode?(d.fn.popover&&d.fn.popover.Constructor&&d.fn.popover.Constructor.prototype.fixTitle||f.error("MissingLibrary",'Bootstrap Popover is required to use "filter-description" plugin. Get it here: http://getbootstrap.com'),this.on("afterUpdateRuleFilter afterUpdateRuleOperator",function(e,t){var r=t.$el.find("button.filter-description"),e=e.builder.getFilterDescription(t.filter,t);e?(0===r.length?((r=d(d.parseHTML('<button type="button" class="btn btn-xs btn-info filter-description" data-toggle="popover"><i class="'+n.icon+'"></i></button>'))).prependTo(t.$el.find(c.selectors.rule_actions)),r.popover({placement:"left",container:"body",html:!0}),r.on("mouseout",function(){r.popover("hide")})):r.css("display",""),r.data("bs.popover").options.content=e,r.attr("aria-describedby")&&r.popover("show")):(r.hide(),r.data("bs.popover")&&r.popover("hide"))})):"bootbox"===n.mode&&("bootbox"in window||f.error("MissingLibrary",'Bootbox is required to use "filter-description" plugin. Get it here: http://bootboxjs.com'),this.on("afterUpdateRuleFilter afterUpdateRuleOperator",function(e,t){var r=t.$el.find("button.filter-description"),e=e.builder.getFilterDescription(t.filter,t);e?(0===r.length?((r=d(d.parseHTML('<button type="button" class="btn btn-xs btn-info filter-description" data-toggle="bootbox"><i class="'+n.icon+'"></i></button>'))).prependTo(t.$el.find(c.selectors.rule_actions)),r.on("click",function(){bootbox.alert(r.data("description"))})):r.css("display",""),r.data("description",e)):r.hide()}))},{icon:"glyphicon glyphicon-info-sign",mode:"popover"}),c.extend({getFilterDescription:function(e,t){if(e)return"function"==typeof e.description?e.description.call(this,t):e.description}}),c.define("invert",function(r){var n=this,i=c.selectors;this.on("afterInit",function(){n.$el.on("click.queryBuilder","[data-invert=group]",function(){var e=d(this).closest(i.group_container);n.invert(n.getModel(e),r)}),r.display_rules_button&&r.invert_rules&&n.$el.on("click.queryBuilder","[data-invert=rule]",function(){var e=d(this).closest(i.rule_container);n.invert(n.getModel(e),r)})}),r.disable_template||(this.on("getGroupTemplate.filter",function(e){var t=d(d.parseHTML(e.value));t.find(i.condition_container).after('<button type="button" class="btn btn-xs btn-default" data-invert="group"><i class="'+r.icon+'"></i> '+n.translate("invert")+"</button>"),e.value=t.prop("outerHTML")}),r.display_rules_button&&r.invert_rules&&this.on("getRuleTemplate.filter",function(e){var t=d(d.parseHTML(e.value));t.find(i.rule_actions).prepend('<button type="button" class="btn btn-xs btn-default" data-invert="rule"><i class="'+r.icon+'"></i> '+n.translate("invert")+"</button>"),e.value=t.prop("outerHTML")}))},{icon:"glyphicon glyphicon-random",recursive:!0,invert_rules:!0,display_rules_button:!1,silent_fail:!1,disable_template:!1}),c.defaults({operatorOpposites:{equal:"not_equal",not_equal:"equal",in:"not_in",not_in:"in",less:"greater_or_equal",less_or_equal:"greater",greater:"less_or_equal",greater_or_equal:"less",between:"not_between",not_between:"between",begins_with:"not_begins_with",not_begins_with:"begins_with",contains:"not_contains",not_contains:"contains",ends_with:"not_ends_with",not_ends_with:"ends_with",is_empty:"is_not_empty",is_not_empty:"is_empty",is_null:"is_not_null",is_not_null:"is_null"},conditionOpposites:{AND:"OR",OR:"AND"}}),c.extend({invert:function(e,t){if(!(e instanceof i)){if(!this.model.root)return;t=e,e=this.model.root}var r,n;void 0===(t="object"!=typeof t?{}:t).recursive&&(t.recursive=!0),void 0===t.invert_rules&&(t.invert_rules=!0),void 0===t.silent_fail&&(t.silent_fail=!1),void 0===t.trigger&&(t.trigger=!0),e instanceof a?(this.settings.conditionOpposites[e.condition]?e.condition=this.settings.conditionOpposites[e.condition]:t.silent_fail||f.error("InvertCondition",'Unknown inverse of condition "{0}"',e.condition),t.recursive&&(r=d.extend({},t,{trigger:!1}),e.each(function(e){t.invert_rules&&this.invert(e,r)},function(e){this.invert(e,r)},this))):e instanceof l&&e.operator&&!e.filter.no_invert&&(this.settings.operatorOpposites[e.operator.type]?(n=this.settings.operatorOpposites[e.operator.type],e.filter.operators&&-1==e.filter.operators.indexOf(n)||(e.operator=this.getOperatorByType(n))):t.silent_fail||f.error("InvertOperator",'Unknown inverse of operator "{0}"',e.operator.type)),t.trigger&&(this.trigger("afterInvert",e,t),this.trigger("rulesChanged"))}}),c.defaults({mongoOperators:{equal:function(e){return e[0]},not_equal:function(e){return{$ne:e[0]}},in:function(e){return{$in:e}},not_in:function(e){return{$nin:e}},less:function(e){return{$lt:e[0]}},less_or_equal:function(e){return{$lte:e[0]}},greater:function(e){return{$gt:e[0]}},greater_or_equal:function(e){return{$gte:e[0]}},between:function(e){return{$gte:e[0],$lte:e[1]}},not_between:function(e){return{$lt:e[0],$gt:e[1]}},begins_with:function(e){return{$regex:"^"+f.escapeRegExp(e[0])}},not_begins_with:function(e){return{$regex:"^(?!"+f.escapeRegExp(e[0])+")"}},contains:function(e){return{$regex:f.escapeRegExp(e[0])}},not_contains:function(e){return{$regex:"^((?!"+f.escapeRegExp(e[0])+").)*$",$options:"s"}},ends_with:function(e){return{$regex:f.escapeRegExp(e[0])+"$"}},not_ends_with:function(e){return{$regex:"(?<!"+f.escapeRegExp(e[0])+")$"}},is_empty:function(e){return""},is_not_empty:function(e){return{$ne:""}},is_null:function(e){return null},is_not_null:function(e){return{$ne:null}}},mongoRuleOperators:{$eq:function(e){return{val:e,op:null===e?"is_null":""===e?"is_empty":"equal"}},$ne:function(e){return{val:e=e.$ne,op:null===e?"is_not_null":""===e?"is_not_empty":"not_equal"}},$regex:function(e){return"^(?!"==(e=e.$regex).slice(0,4)&&")"==e.slice(-1)?{val:e.slice(4,-1),op:"not_begins_with"}:"^((?!"==e.slice(0,5)&&").)*$"==e.slice(-5)?{val:e.slice(5,-5),op:"not_contains"}:"(?<!"==e.slice(0,4)&&")$"==e.slice(-2)?{val:e.slice(4,-2),op:"not_ends_with"}:"$"==e.slice(-1)?{val:e.slice(0,-1),op:"ends_with"}:"^"==e.slice(0,1)?{val:e.slice(1),op:"begins_with"}:{val:e,op:"contains"}},between:function(e){return{val:[e.$gte,e.$lte],op:"between"}},not_between:function(e){return{val:[e.$lt,e.$gt],op:"not_between"}},$in:function(e){return{val:e.$in,op:"in"}},$nin:function(e){return{val:e.$nin,op:"not_in"}},$lt:function(e){return{val:e.$lt,op:"less"}},$lte:function(e){return{val:e.$lte,op:"less_or_equal"}},$gt:function(e){return{val:e.$gt,op:"greater"}},$gte:function(e){return{val:e.$gte,op:"greater_or_equal"}}}}),c.extend({getMongo:function(e){var o;return(e=void 0===e?this.getRules():e)?(o=this,function n(e){var i,t;return e.condition||(e.condition=o.settings.default_condition),-1===["AND","OR"].indexOf(e.condition.toUpperCase())&&f.error("UndefinedMongoCondition",'Unable to build MongoDB query with condition "{0}"',e.condition),e.rules?(i=[],e.rules.forEach(function(e){var t,r;e.rules&&0<e.rules.length?i.push(n(e)):(t=o.settings.mongoOperators[e.operator],r=o.getOperatorByType(e.operator),void 0===t&&f.error("UndefinedMongoOperator",'Unknown MongoDB operation for operator "{0}"',e.operator),0===r.nb_inputs||e.value instanceof Array||(e.value=[e.value]),(r={})[o.change("getMongoDBField",e.field,e)]=t.call(o,e.value),i.push(o.change("ruleToMongo",r,e,e.value,t)))}),(t={})["$"+e.condition.toLowerCase()]=i,o.change("groupToMongo",t,e)):{}}(e)):null},getRulesFromMongo:function(e){var s,t;return null==e?null:"rules"in(e=(s=this).change("parseMongoNode",e))&&"condition"in e?e:"id"in e&&"operator"in e&&"value"in e?{condition:this.settings.default_condition,rules:[e]}:((t=s.getMongoCondition(e))||f.error("MongoParse","Invalid MongoDB query format"),function o(e,t){var r=e[t],l=[];return r.forEach(function(e){var t,r,n,i;"rules"in(e=s.change("parseMongoNode",e))&&"condition"in e||"id"in e&&"operator"in e&&"value"in e?l.push(e):(t=s.getMongoCondition(e))?l.push(o(e,t)):(i=e[t=Object.keys(e)[0]],void 0===(r=s.getMongoOperator(i))&&f.error("MongoParse","Invalid MongoDB query format"),void 0===(n=s.settings.mongoRuleOperators[r])&&f.error("UndefinedMongoOperator",'JSON Rule operation unknown for operator "{0}"',r),r=n.call(s,i),n=s.getMongoDBFieldID(t,i),i=s.change("mongoToRule",{id:n,field:t,operator:r.op,value:r.val},e),l.push(i))}),s.change("mongoToGroup",{condition:t.replace("$","").toUpperCase(),rules:l},e)}(e,t))},setRulesFromMongo:function(e){this.setRules(this.getRulesFromMongo(e))},getMongoDBFieldID:function(t,e){var r=this.filters.filter(function(e){return e.field===t}),r=1===r.length?r[0].id:this.change("getMongoDBFieldID",t,e);return r},getMongoOperator:function(e){return null!==e&&"object"==typeof e?void 0!==e.$gte&&void 0!==e.$lte?"between":void 0!==e.$lt&&void 0!==e.$gt?"not_between":1===(e=Object.keys(e).filter(function(e){return!!this.settings.mongoRuleOperators[e]}.bind(this))).length?e[0]:void 0:"$eq"},getMongoCondition:function(e){for(var t=Object.keys(e),r=0,n=t.length;r<n;r++)if("$or"===t[r].toLowerCase()||"$and"===t[r].toLowerCase())return t[r]}}),c.define("not-group",function(r){var n=this;this.on("afterInit",function(){n.$el.on("click.queryBuilder","[data-not=group]",function(){var e=d(this).closest(c.selectors.group_container),e=n.getModel(e);e.not=!e.not}),n.model.on("update",function(e,t,r){t instanceof a&&"not"===r&&n.updateGroupNot(t)})}),this.on("afterAddGroup",function(e,t){t.__.not=!1}),r.disable_template||this.on("getGroupTemplate.filter",function(e){var t=d(d.parseHTML(e.value));t.find(c.selectors.condition_container).prepend('<button type="button" class="btn btn-xs btn-default" data-not="group"><i class="'+r.icon_unchecked+'"></i> '+n.translate("NOT")+"</button>"),e.value=t.prop("outerHTML")}),this.on("groupToJson.filter",function(e,t){e.value.not=t.not}),this.on("jsonToGroup.filter",function(e,t){e.value.not=!!t.not}),this.on("groupToSQL.filter",function(e,t){t.not&&(e.value="NOT ( "+e.value+" )")}),this.on("parseSQLNode.filter",function(e){e.value.name&&"NOT"==e.value.name.toUpperCase()&&(e.value=e.value.arguments.value[0],-1===["AND","OR"].indexOf(e.value.operation.toUpperCase())&&(e.value=new SQLParser.nodes.Op(n.settings.default_condition,e.value,null)),e.value.not=!0)}),this.on("sqlGroupsDistinct.filter",function(e,t,r,n){r.not&&0<n&&(e.value=!0)}),this.on("sqlToGroup.filter",function(e,t){e.value.not=!!t.not}),this.on("groupToMongo.filter",function(e,t){var r="$"+t.condition.toLowerCase();t.not&&e.value[r]&&(e.value={$nor:[e.value]})}),this.on("parseMongoNode.filter",function(e){var t=Object.keys(e.value);"$nor"==t[0]&&(e.value=e.value[t[0]][0],e.value.not=!0)}),this.on("mongoToGroup.filter",function(e,t){e.value.not=!!t.not})},{icon_unchecked:"glyphicon glyphicon-unchecked",icon_checked:"glyphicon glyphicon-check",disable_template:!1}),f.defineModelProperties(a,["not"]),c.selectors.group_not=c.selectors.group_header+" [data-not=group]",c.extend({updateGroupNot:function(e){var t=this.plugins["not-group"];e.$el.find(">"+c.selectors.group_not).toggleClass("active",e.not).find("i").attr("class",e.not?t.icon_checked:t.icon_unchecked),this.trigger("afterUpdateGroupNot",e),this.trigger("rulesChanged")}}),c.define("sortable",function(n){var i,o,l,s;"interact"in window||f.error("MissingLibrary",'interact.js is required to use "sortable" plugin. Get it here: http://interactjs.io'),void 0!==n.default_no_sortable&&(f.error(!1,"Config",'Sortable plugin : "default_no_sortable" options is deprecated, use standard "default_rule_flags" and "default_group_flags" instead'),this.settings.default_rule_flags.no_sortable=this.settings.default_group_flags.no_sortable=n.default_no_sortable),interact.dynamicDrop(!0),interact.pointerMoveTolerance(10),this.on("afterAddRule afterAddGroup",function(e,t){var r;t==i||(r=e.builder,n.inherit_no_sortable&&t.parent&&t.parent.flags.no_sortable&&(t.flags.no_sortable=!0),n.inherit_no_drop&&t.parent&&t.parent.flags.no_drop&&(t.flags.no_drop=!0),t.flags.no_sortable||interact(t.$el[0]).draggable({allowFrom:c.selectors.drag_handle,onstart:function(e){s=!1,l=r.getModel(e.target),o=l.$el.clone().appendTo(l.$el.parent()).width(l.$el.outerWidth()).addClass("dragging");e=d(d.parseHTML('<div class="rule-placeholder">&nbsp;</div>')).height(l.$el.outerHeight());i=l.parent.addRule(e,l.getPos()),l.$el.hide()},onmove:function(e){o[0].style.top=e.clientY-15+"px",o[0].style.left=e.clientX-15+"px"},onend:function(e){e.dropzone&&(u(l,d(e.relatedTarget),r),s=!0),o.remove(),o=void 0,i.drop(),i=void 0,l.$el.css("display",""),r.trigger("afterMove",l),r.trigger("rulesChanged")}}),t.flags.no_drop)||(interact(t.$el[0]).dropzone({accept:c.selectors.rule_and_group_containers,ondragenter:function(e){u(i,d(e.target),r)},ondrop:function(e){s||u(l,d(e.target),r)}}),t instanceof a&&interact(t.$el.find(c.selectors.group_header)[0]).dropzone({accept:c.selectors.rule_and_group_containers,ondragenter:function(e){u(i,d(e.target),r)},ondrop:function(e){s||u(l,d(e.target),r)}}))}),this.on("beforeDeleteRule beforeDeleteGroup",function(e,t){e.isDefaultPrevented()||(interact(t.$el[0]).unset(),t instanceof a&&interact(t.$el.find(c.selectors.group_header)[0]).unset())}),this.on("afterApplyRuleFlags afterApplyGroupFlags",function(e,t){t.flags.no_sortable&&t.$el.find(".drag-handle").remove()}),n.disable_template||(this.on("getGroupTemplate.filter",function(e,t){1<t&&((t=d(d.parseHTML(e.value))).find(c.selectors.condition_container).after('<div class="drag-handle"><i class="'+n.icon+'"></i></div>'),e.value=t.prop("outerHTML"))}),this.on("getRuleTemplate.filter",function(e){var t=d(d.parseHTML(e.value));t.find(c.selectors.rule_header).after('<div class="drag-handle"><i class="'+n.icon+'"></i></div>'),e.value=t.prop("outerHTML")}))},{inherit_no_sortable:!0,inherit_no_drop:!0,icon:"glyphicon glyphicon-sort",disable_template:!1}),c.selectors.rule_and_group_containers=c.selectors.rule_container+", "+c.selectors.group_container,c.selectors.drag_handle=".drag-handle",c.defaults({default_rule_flags:{no_sortable:!1,no_drop:!1},default_group_flags:{no_sortable:!1,no_drop:!1}}),c.define("sql-support",function(e){},{boolean_as_integer:!0}),c.defaults({sqlOperators:{equal:{op:"= ?"},not_equal:{op:"!= ?"},in:{op:"IN(?)",sep:", "},not_in:{op:"NOT IN(?)",sep:", "},less:{op:"< ?"},less_or_equal:{op:"<= ?"},greater:{op:"> ?"},greater_or_equal:{op:">= ?"},between:{op:"BETWEEN ?",sep:" AND "},not_between:{op:"NOT BETWEEN ?",sep:" AND "},begins_with:{op:"LIKE ?",mod:"{0}%",escape:"%_"},not_begins_with:{op:"NOT LIKE ?",mod:"{0}%",escape:"%_"},contains:{op:"LIKE ?",mod:"%{0}%",escape:"%_"},not_contains:{op:"NOT LIKE ?",mod:"%{0}%",escape:"%_"},ends_with:{op:"LIKE ?",mod:"%{0}",escape:"%_"},not_ends_with:{op:"NOT LIKE ?",mod:"%{0}",escape:"%_"},is_empty:{op:"= ''"},is_not_empty:{op:"!= ''"},is_null:{op:"IS NULL"},is_not_null:{op:"IS NOT NULL"}},sqlRuleOperator:{"=":function(e){return{val:e,op:""===e?"is_empty":"equal"}},"!=":function(e){return{val:e,op:""===e?"is_not_empty":"not_equal"}},LIKE:function(e){return"%"==e.slice(0,1)&&"%"==e.slice(-1)?{val:e.slice(1,-1),op:"contains"}:"%"==e.slice(0,1)?{val:e.slice(1),op:"ends_with"}:"%"==e.slice(-1)?{val:e.slice(0,-1),op:"begins_with"}:void f.error("SQLParse",'Invalid value for LIKE operator "{0}"',e)},"NOT LIKE":function(e){return"%"==e.slice(0,1)&&"%"==e.slice(-1)?{val:e.slice(1,-1),op:"not_contains"}:"%"==e.slice(0,1)?{val:e.slice(1),op:"not_ends_with"}:"%"==e.slice(-1)?{val:e.slice(0,-1),op:"not_begins_with"}:void f.error("SQLParse",'Invalid value for NOT LIKE operator "{0}"',e)},IN:function(e){return{val:e,op:"in"}},"NOT IN":function(e){return{val:e,op:"not_in"}},"<":function(e){return{val:e,op:"less"}},"<=":function(e){return{val:e,op:"less_or_equal"}},">":function(e){return{val:e,op:"greater"}},">=":function(e){return{val:e,op:"greater_or_equal"}},BETWEEN:function(e){return{val:e,op:"between"}},"NOT BETWEEN":function(e){return{val:e,op:"not_between"}},IS:function(e){return null!==e&&f.error("SQLParse","Invalid value for IS operator"),{val:null,op:"is_null"}},"IS NOT":function(e){return null!==e&&f.error("SQLParse","Invalid value for IS operator"),{val:null,op:"is_not_null"}}},sqlStatements:{question_mark:function(){var r=[];return{add:function(e,t){return r.push(t),"?"},run:function(){return r}}},numbered:function(r){(!r||1<r.length)&&(r="$");var n=0,i=[];return{add:function(e,t){return i.push(t),r+ ++n},run:function(){return i}}},named:function(r){(!r||1<r.length)&&(r=":");var n={},i={};return{add:function(e,t){n[e.field]||(n[e.field]=1);e=e.field+"_"+n[e.field]++;return i[e]=t,r+e},run:function(){return i}}}},sqlRuleStatement:{question_mark:function(t){var r=0;return{parse:function(e){return"?"==e?t[r++]:e},esc:function(e){return e.replace(/\?/g,"'?'")}}},numbered:function(t,r){(!r||1<r.length)&&(r="$");var n=new RegExp("^\\"+r+"[0-9]+$"),i=new RegExp("\\"+r+"([0-9]+)","g");return{parse:function(e){return n.test(e)?t[e.slice(1)-1]:e},esc:function(e){return e.replace(i,"'"+("$"==r?"$$":r)+"$1'")}}},named:function(t,r){(!r||1<r.length)&&(r=":");var n=new RegExp("^\\"+r),i=new RegExp("\\"+r+"("+Object.keys(t).join("|")+")\\b","g");return{parse:function(e){return n.test(e)?t[e.slice(1)]:e},esc:function(e){return e.replace(i,"'"+("$"==r?"$$":r)+"$1'")}}}}}),c.extend({getSQL:function(s,a,e){if(!(e=void 0===e?this.getRules():e))return null;a=a?"\n":" ";var u=this.getPluginOptions("sql-support","boolean_as_integer"),p=("string"==typeof(s=!0===s?"question_mark":s)&&(t=n(s),s=this.settings.sqlStatements[t[1]](t[2])),this),t=function o(e){var l,t;return e.condition||(e.condition=p.settings.default_condition),-1===["AND","OR"].indexOf(e.condition.toUpperCase())&&f.error("UndefinedSQLCondition",'Unable to build SQL query with condition "{0}"',e.condition),e.rules?(l=[],e.rules.forEach(function(r){var n,i,e,t;r.rules&&0<r.rules.length?l.push("("+a+o(r)+a+")"+a):(n=p.settings.sqlOperators[r.operator],e=p.getOperatorByType(r.operator),i="",void 0===n&&f.error("UndefinedSQLOperator",'Unknown SQL operation for operator "{0}"',r.operator),0!==e.nb_inputs&&(r.value instanceof Array||(r.value=[r.value]),r.value.forEach(function(e,t){0<t&&(i+=n.sep),"boolean"==r.type&&u?e=e?1:0:s||"integer"===r.type||"double"===r.type||"boolean"===r.type||(e=f.escapeString(e,n.escape)),n.mod&&(e=f.fmt(n.mod,e)),i+=s?s.add(r,e):"string"==typeof e?"'"+e+"'":e})),e=function(e){return n.op.replace("?",function(){return e})},t=p.change("getSQLField",r.field,r)+" "+e(i),l.push(p.change("ruleToSQL",t,r,i,e)))}),t=l.join(" "+e.condition+a),p.change("groupToSQL",t,e)):""}(e);return s?{sql:t,params:s.run()}:{sql:t}},getRulesFromSQL:function(e,s){"SQLParser"in window||f.error("MissingLibrary","SQLParser is required to parse SQL queries. Get it here https://github.com/mistic100/sql-parser");var a,u=this,t=("string"==typeof e&&(e={sql:e}),"string"==typeof(s=!0===s?"question_mark":s)&&(t=n(s),s=this.settings.sqlRuleStatement[t[1]](e.params,t[2])),s&&(e.sql=s.esc(e.sql)),0!==e.sql.toUpperCase().indexOf("SELECT")&&(e.sql="SELECT * FROM table WHERE "+e.sql),SQLParser.parse(e.sql)),e=(t.where||f.error("SQLParse","No WHERE clause found"),u.change("parseSQLNode",t.where.conditions));return"rules"in e&&"condition"in e?e:"id"in e&&"operator"in e&&"value"in e?{condition:this.settings.default_condition,rules:[e]}:(t=u.change("sqlToGroup",{condition:this.settings.default_condition,rules:[]},e),a=t,function e(t,r){var n,i,o,l;null!==t&&("rules"in(t=u.change("parseSQLNode",t))&&"condition"in t||"id"in t&&"operator"in t&&"value"in t?a.rules.push(t):("left"in t&&"right"in t&&"operation"in t||f.error("SQLParse","Unable to parse WHERE clause"),-1!==["AND","OR"].indexOf(t.operation.toUpperCase())?(u.change("sqlGroupsDistinct",0<r&&a.condition!=t.operation.toUpperCase(),a,t,r)&&(l=u.change("sqlToGroup",{condition:u.settings.default_condition,rules:[]},t),a.rules.push(l),a=l),a.condition=t.operation.toUpperCase(),l=a,e(t.left,++r),a=l,e(t.right,r)):(d.isPlainObject(t.right.value)&&f.error("SQLParse","Value format not supported for {0}.",t.left.value),l=d.isArray(t.right.value)?t.right.value.map(function(e){return e.value}):t.right.value,s&&(l=d.isArray(l)?l.map(s.parse):s.parse(l)),r=t.operation.toUpperCase(),void 0===(r=u.settings.sqlRuleOperator[r="<>"==r?"!=":r])&&f.error("UndefinedSQLOperator",'Invalid SQL operation "{0}".',t.operation),r=r.call(this,l,t.operation),"values"in t.left?n=t.left.values.join("."):"value"in t.left?n=t.left.value:f.error("SQLParse","Cannot find field name in {0}",JSON.stringify(t.left)),i=r.val,o=u.settings.sqlOperators[r.op],!s&&o&&o.escape&&(o=o.escape.split("").map(function(e){return"\\\\"+e}).join("|"),i=i.replace(new RegExp("("+o+")","g"),function(e){return e[1]})),o=u.getSQLFieldID(n,l),l=u.change("sqlToRule",{id:o,field:n,operator:r.op,value:i},t),a.rules.push(l))))}(e,0),t)},setRulesFromSQL:function(e,t){this.setRules(this.getRulesFromSQL(e,t))},getSQLFieldID:function(t,e){var r=this.filters.filter(function(e){return e.field.toLowerCase()===t.toLowerCase()}),r=1===r.length?r[0].id:this.change("getSQLFieldID",t,e);return r}}),c.define("unique-filter",function(){this.status.used_filters={},this.on("afterUpdateRuleFilter",this.updateDisabledFilters),this.on("afterDeleteRule",this.updateDisabledFilters),this.on("afterCreateRuleFilters",this.applyDisabledFilters),this.on("afterReset",this.clearDisabledFilters),this.on("afterClear",this.clearDisabledFilters),this.on("getDefaultFilter.filter",function(t,r){var n=t.builder;n.updateDisabledFilters(),t.value.id in n.status.used_filters&&(n.filters.some(function(e){if(!(e.id in n.status.used_filters)||0<n.status.used_filters[e.id].length&&-1===n.status.used_filters[e.id].indexOf(r.parent))return t.value=e,!0})||(f.error(!1,"UniqueFilter","No more non-unique filters available"),t.value=void 0))})}),c.extend({updateDisabledFilters:function(e){var r=e?e.builder:this;r.status.used_filters={},r.model&&(function t(e){e.each(function(e){e.filter&&e.filter.unique&&(r.status.used_filters[e.filter.id]||(r.status.used_filters[e.filter.id]=[]),"group"==e.filter.unique)&&r.status.used_filters[e.filter.id].push(e.parent)},function(e){t(e)})}(r.model.root),r.applyDisabledFilters(e))},clearDisabledFilters:function(e){var t=e?e.builder:this;t.status.used_filters={},t.applyDisabledFilters(e)},applyDisabledFilters:function(e){var r=e?e.builder:this;r.$el.find(c.selectors.filter_container+" option").prop("disabled",!1),d.each(r.status.used_filters,function(t,e){0===e.length?r.$el.find(c.selectors.filter_container+' option[value="'+t+'"]:not(:selected)').prop("disabled",!0):e.forEach(function(e){e.each(function(e){e.$el.find(c.selectors.filter_container+' option[value="'+t+'"]:not(:selected)').prop("disabled",!0)})})}),r.settings.plugins&&r.settings.plugins["bt-selectpicker"]&&r.$el.find(c.selectors.rule_filter).selectpicker("render")}}),c.regional.en={__locale:"English (en)",__author:'Damien "Mistic" Sorel, http://www.strangeplanet.fr',add_rule:"Add rule",add_group:"Add group",delete_rule:"Delete",delete_group:"Delete",conditions:{AND:"AND",OR:"OR"},operators:{equal:"equal",not_equal:"not equal",in:"in",not_in:"not in",less:"less",less_or_equal:"less or equal",greater:"greater",greater_or_equal:"greater or equal",between:"between",not_between:"not between",begins_with:"begins with",not_begins_with:"doesn't begin with",contains:"contains",not_contains:"doesn't contain",ends_with:"ends with",not_ends_with:"doesn't end with",is_empty:"is empty",is_not_empty:"is not empty",is_null:"is null",is_not_null:"is not null"},errors:{no_filter:"No filter selected",empty_group:"The group is empty",radio_empty:"No value selected",checkbox_empty:"No value selected",select_empty:"No value selected",string_empty:"Empty value",string_exceed_min_length:"Must contain at least {0} characters",string_exceed_max_length:"Must not contain more than {0} characters",string_invalid_format:"Invalid format ({0})",number_nan:"Not a number",number_not_integer:"Not an integer",number_not_double:"Not a real number",number_exceed_min:"Must be greater than {0}",number_exceed_max:"Must be lower than {0}",number_wrong_step:"Must be a multiple of {0}",number_between_invalid:"Invalid values, {0} is greater than {1}",datetime_empty:"Empty value",datetime_invalid:"Invalid date format ({0})",datetime_exceed_min:"Must be after {0}",datetime_exceed_max:"Must be before {0}",datetime_between_invalid:"Invalid values, {0} is greater than {1}",boolean_not_valid:"Not a boolean",operator_not_multiple:'Operator "{1}" cannot accept multiple values'},invert:"Invert",NOT:"NOT"},c.defaults({lang_code:"en"}),c});